name: Deploy RabbitMQ

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Deploy to server
      env:
        SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        HOST: ${{ secrets.DEPLOY_HOST }}
        USER: ${{ secrets.DEPLOY_USER }}
        RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
        RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
        RABBITMQ_VHOST: ${{ secrets.RABBITMQ_VHOST }}
      run: |
        echo "$SSH_KEY" > key.pem
        chmod 600 key.pem
        
        # Создаем .env файл из секретов (RABBITMQ_VHOST опциональный, по умолчанию /)
        cat > .env << EOF
        RABBITMQ_USER=$RABBITMQ_USER
        RABBITMQ_PASSWORD=$RABBITMQ_PASSWORD
        RABBITMQ_VHOST=${RABBITMQ_VHOST:-/}
        EOF
        
        # Настройки SSH для CI/CD (отключаем проверку host key)
        SSH_OPTS="-i key.pem -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
        
        # Создаем директорию на сервере если её нет
        ssh $SSH_OPTS $USER@$HOST "mkdir -p ~/infra"
        
        # Копируем файлы на сервер
        scp $SSH_OPTS docker-compose.yml .env $USER@$HOST:~/infra/
        
        ssh $SSH_OPTS $USER@$HOST "
          cd ~/infra
          
          # Останавливаем и удаляем старый контейнер если существует
          docker-compose down || true
          
          # Запускаем RabbitMQ
          docker-compose up -d
          
          # Проверяем статус
          docker-compose ps
        "
        
        # Очищаем ключ и .env
        rm -f key.pem .env
